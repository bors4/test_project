name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (lint, format, qodana)
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (full fetch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Check formatting with Prettier
        run: npm run format || (echo "‚ùå Prettier failed" && exit 1)

      - name: Lint with ESLint
        run: npm run lint || (echo "‚ùå ESLint failed" && exit 1)

      - name: Debug git / SHAs (optional)
        run: |
          echo "EVENT: $GITHUB_EVENT_NAME"
          echo "github.sha = ${{ github.sha }}"
          echo "pr.head.sha = ${{ github.event.pull_request.head.sha || 'N/A' }}"
          git --no-pager log -n 5 --pretty=format:"%H %an %s"
          git branch -a
          git rev-parse --verify --quiet "${{ github.sha }}" || echo "Commit ${{ github.sha }} not found locally"

      - name: Ensure commit is present for Qodana
        run: |
          git fetch --unshallow || true
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.head.ref }} --depth=1 || true
            git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1 || true
          fi

      - name: Run Qodana (Community Docker)
        env:
          QODANA_IMAGE: jetbrains/qodana-community-js:2025.2
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMIT="${{ github.event.pull_request.head.sha }}"
          else
            COMMIT="${{ github.sha }}"
          fi
          echo "Running Qodana Community for commit: $COMMIT"
          mkdir -p "${{ github.workspace }}/.qodana-cache"
          mkdir -p "${{ github.workspace }}/results"
          docker run --rm \
            -v "${{ github.workspace }}":/data \
            -v "${{ github.workspace }}/.qodana-cache":/root/.cache/qodana \
            $QODANA_IMAGE scan \
              --cache-dir /root/.cache/qodana \
              --results-dir /data/results \
              --project-dir /data \
              --commit "$COMMIT"

      - name: Upload Qodana results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qodana-results
          path: results/
          retention-days: 7

  # –≠—Ç–∞–ø 2: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ –º–∞—Ç—Ä–∏—Ü–µ
  e2e-tests:
    needs: code-quality
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        browser: [chrome, firefox]
        include:
          - os: ubuntu-latest
            browser: chrome-mobile

    steps:
      - name: Checkout code (full fetch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Set up Chrome (for Linux/macOS/Windows)
        if: matrix.browser == 'chrome' || matrix.browser == 'chrome-mobile'
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Set up Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1
        with:
          firefox-version: stable

      - name: Run tests
        run: |
          if [ "${{ matrix.browser }}" = "chrome-mobile" ]; then
            npm run test:mobile
          else
            npm run test:browser -- --browser=${{ matrix.browser }}
          fi
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
          DOTENVX_LOG: off
          BROWSER: ${{ matrix.browser }}

      - name: Generate Allure report
        if: always()
        run: npx allure generate allure-results -o allure-report --clean

      - name: Upload videos (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ matrix.os }}-${{ matrix.browser }}
          path: videos/
          retention-days: 7

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.os }}-${{ matrix.browser }}
          path: allure-report/
          retention-days: 7

  # –≠—Ç–∞–ø 3: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è)
  notify-telegram:
    needs: e2e-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message || github.event.pull_request.title || 'N/A' }}"
          AUTHOR="${{ github.event.head_commit.author.name || github.event.pull_request.user.login || 'N/A' }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üö® CI —É–ø–∞–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ${{ github.repository }}
            –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            –ö–æ–º–º–∏—Ç: $COMMIT_MSG
            –ê–≤—Ç–æ—Ä: $AUTHOR
            –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"