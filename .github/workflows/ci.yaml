name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (lint, format, qodana)
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (full fetch)
        uses: actions/checkout@v4
        with:
          # –í–∞–∂–Ω–æ: –ø–æ–ª–Ω—ã–π fetch, —á—Ç–æ–±—ã Qodana –∏ git –∫–æ–º–∞–Ω–¥—ã –º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–µ SHA/merge-refs
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Check formatting with Prettier
        run: npm run format || (echo "‚ùå Prettier failed" && exit 1)

      - name: Lint with ESLint
        run: npm run lint || (echo "‚ùå ESLint failed" && exit 1)

      # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π —à–∞–≥, –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –ø—Ä–æ–±–ª–µ–º —Å SHA
      - name: Debug git / SHAs (optional)
        run: |
          echo "GITHUB_EVENT_NAME = $GITHUB_EVENT_NAME"
          echo "github.sha = ${{ github.sha }}"
          echo "pr.head.sha = ${{ github.event.pull_request.head.sha || 'N/A' }}"
          git --no-pager log -n 3 --pretty=format:"%H %an %s"
          git branch -a
          git rev-parse --verify --quiet "${{ github.sha }}" || echo "Commit ${{ github.sha }} not found locally"

      # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–ª–æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω—É–∂–Ω—ã–π –∫–æ–º–º–∏—Ç (–µ—Å–ª–∏ –æ–Ω –±—ã–ª shallow)
      - name: Ensure commit is present for Qodana
        run: |
          # –ü–æ–ø—ã—Ç–∫–∞ unshallow - –±–µ–∑–æ–ø–∞—Å–Ω–æ, –µ—Å–ª–∏ –Ω–µ shallow
          git fetch --unshallow || true
          # –ï—Å–ª–∏ —ç—Ç–æ PR, –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å head/base —è–≤–Ω—ã–º fetch'–µ–º (–∑–∞—â–∏—Ç–Ω—ã–π —à–∞–≥)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.head.ref }} --depth=1 || true
            git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1 || true
          fi

      - name: Run Qodana
        run: |
          # –í—ã–±–∏—Ä–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SHA: –¥–ª—è PR ‚Äî head SHA, –∏–Ω–∞—á–µ ‚Äî github.sha
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMIT="${{ github.event.pull_request.head.sha }}"
          else
            COMMIT="${{ github.sha }}"
          fi
          echo "Running qodana scan for commit: $COMMIT"
          qodana scan --cache-dir ./cache --results-dir ./results --commit "$COMMIT"
        # –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —É–±—Ä–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –≤—ã—à–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ qodana –±–µ–∑ --commit,
        # –Ω–æ —Ç–æ–≥–¥–∞ Qodana –º–æ–∂–µ—Ç –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤—ã—á–∏—Å–ª—è—Ç—å merge-base –∏ —Å–Ω–æ–≤–∞ –Ω–∞—Ç–∫–Ω—É—Ç—å—Å—è –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ—Ñ–∞.

  # –≠—Ç–∞–ø 2: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ –º–∞—Ç—Ä–∏—Ü–µ
  e2e-tests:
    needs: code-quality
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        browser: [chrome, firefox]
        include:
          - os: ubuntu-latest
            browser: chrome-mobile

    steps:
      - name: Checkout code (full fetch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Set up Chrome (for Linux/macOS/Windows)
        if: matrix.browser == 'chrome' || matrix.browser == 'chrome-mobile'
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Set up Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1
        with:
          firefox-version: stable

      - name: Run tests
        run: |
          if [ "${{ matrix.browser }}" = "chrome-mobile" ]; then
            npm run test:mobile
          else
            npm run test:browser -- --browser=${{ matrix.browser }}
          fi
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
          DOTENVX_LOG: off
          BROWSER: ${{ matrix.browser }}

      - name: Generate Allure report
        if: always()
        run: npx allure generate allure-results -o allure-report --clean

      - name: Upload videos (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ matrix.os }}-${{ matrix.browser }}
          path: videos/
          retention-days: 7

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.os }}-${{ matrix.browser }}
          path: allure-report/
          retention-days: 7

  # –≠—Ç–∞–ø 3: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è)
  notify-telegram:
    needs: e2e-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üö® CI —É–ø–∞–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ${{ github.repository }}
            –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}
            –ê–≤—Ç–æ—Ä: ${{ github.event.head_commit.author.name }}
            –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"